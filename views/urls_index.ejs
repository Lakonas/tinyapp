<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/styles/style.css" />
    
    <title>ShortStop - My URLs</title>
  </head>
  <body>
    <%- include('partials/_header') %>

    <main style="margin: 1em;">
      <% if (message) { %>
        <!-- If the message exists, show the message to the user -->
        <div class="alert alert-warning" role="alert">
          <%= message %>
        </div>
      <% } else { %>
        <!-- Display the table with URLs if the user is logged in -->
        <h3>My URLs</h3>
        <table class="table">
          <thead>
            <tr>
              <th scope="col">Short URL ID</th>
              <th scope="col">Long URL</th>
              <th scope="col">Clicks</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% for (let id in urls) { %>
              <tr>
                <td>
                  <a href="/u/<%= id %>" target="_blank"><%= id %></a>
                  <button 
                    class="btn btn-sm btn-outline-secondary ml-2" 
                    onclick="copyShortURL('<%= id %>')"
                    title="Copy short URL">
                    üìã Copy
                  </button>
                </td>
                <td><%= urls[id].longURL %></td>
                <td><strong><%= urls[id].clicks %></strong></td>
                <td>
                  <form method="POST" action="/urls/<%= id %>" style="display: inline;">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                  </form>
                  <button 
                    class="btn btn-primary btn-sm" 
                    onclick="openEditModal('<%= id %>', '<%= urls[id].longURL %>')">
                    Quick Edit
                  </button>
                  <a href="/urls/<%= id %>" class="btn btn-secondary btn-sm">Details</a>
                  <a href="/urls/<%= id %>/analytics" class="btn btn-info btn-sm">üìä Analytics</a>
                </td>

                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      <% } %>
    </main>

    <!-- Edit Modal (Vanilla JS) -->
<div id="editModal" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h5 class="modal-title">Edit URL</h5>
      <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Edit Form -->
      <form id="editForm" method="POST" action="">
        <input type="hidden" name="_method" value="PUT">
        <div class="form-group">
          <label for="modalShortCode">Short URL ID:</label>
          <input 
              type="text" 
              id="modalShortCode" 
              class="form-control modal-readonly" 
              readonly>
        </div>
        <div class="form-group">
          <label for="modalLongURL">Long URL:</label>
          <input 
            type="text" 
            id="modalLongURL" 
            name="longURL" 
            class="form-control" 
            required>
        </div>
      </form>

      <!-- QR Code Section -->
      <div class="text-center mt-4">
        <h6>QR Code</h6>
        <img 
            id="modalQRCode" 
            src="" 
            alt="QR Code" 
            class="img-fluid modal-qr-image">
        <br>
        <a 
          id="modalQRDownload" 
          href="" 
          download="" 
          class="btn btn-info btn-sm mt-4">
          Download QR Code
        </a>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
      <button type="button" class="btn btn-primary" onclick="submitEdit()">Update URL</button>
    </div>
  </div>
</div>

   
    <!-- Modal JavaScript -->
   <!-- Modal JavaScript (Vanilla JS) -->
<script>
  function openEditModal(shortCode, longURL) {
    // Set form action
    document.getElementById('editForm').action = '/urls/' + shortCode;
    
    // Populate form fields
    document.getElementById('modalShortCode').value = shortCode;
    document.getElementById('modalLongURL').value = longURL;
    
    // Set QR code image
    document.getElementById('modalQRCode').src = '/urls/' + shortCode + '/qr';
    
    // Set QR download link
    const downloadLink = document.getElementById('modalQRDownload');
    downloadLink.href = '/urls/' + shortCode + '/qr';
    downloadLink.download = 'qrcode-' + shortCode + '.png';
    
    // Show modal (vanilla JS)
    document.getElementById('editModal').style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scroll
  }

  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Re-enable scroll
  }

  function submitEdit() {
    // Validate before submitting
    const longURL = document.getElementById('modalLongURL').value;
    
    if (!longURL || longURL.trim() === '') {
      alert('‚ö†Ô∏è URL is required!');
      return;
    }
    
    // Submit the form
    document.getElementById('editForm').submit();
  }

  // Copy short URL to clipboard
  function copyShortURL(shortCode) {
  const shortURL = '<%= baseURL %>/u/' + shortCode;
  
  // Modern clipboard API
  navigator.clipboard.writeText(shortURL).then(function() {
    // Success - show temporary feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '‚úÖ Copied!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    // Reset after 2 seconds
    setTimeout(function() {
      button.innerHTML = originalText;
      button.classList.remove('btn-success');
      button.classList.add('btn-outline-secondary');
    }, 2000);
  }).catch(function(err) {
    // Fallback for older browsers
    alert('Short URL: ' + shortURL);
  });
}

  // Close modal when clicking outside
  document.addEventListener('click', function(event) {
    const modal = document.getElementById('editModal');
    if (event.target === modal) {
      closeEditModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      const modal = document.getElementById('editModal');
      if (modal.style.display === 'flex') {
        closeEditModal();
      }
    }
  });
</script>
  </body>
</html>